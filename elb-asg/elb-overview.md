****
**What is a Load Balancer?**

* Load Balancers are servers that forward traffic to multiple servers downstream

**Why use a Load Balancer?**

* Spread across multiple downstream instances
* Expose a single point of access (DNS) to your application
* Seamlessly handle failures of downstream instances 
* Do regular health checks to your instances
* Provides SSL termination (HTTPS) for your websites
* Enforce stickiness with cookies
* High Avaliability accross zones
* Separates public traffic from private traffic

**Why use an Elastic Load Balancer?**

* An Elastic Load Balancer is a **managed load balancer**
    * AWS guarantees that will be working 
    * AWS takes care of upgrades, maintance, high avaliability
    * AWS provides only a few configuration knobs

* It costs less to setup your own Load Balancerm but it will be a lot more of effort from your part
* Its integrated with many AWS Offering/Services
    * EC2, EC2 Auto Scaling Groups, Amazon ECS
    * AWS Certificate Manager (ACM), Cloud Watch
    * Route 53, AWS WAF, AWS Global Accelerator

**Health Checks**

* Health checks are crucial for Load Balancers
* They enable the load balancer to know if instances it forwards traffics to are avaliable to reply requests
* The healtcheck is done on a port and a route (/health is common)
****

**Types of Load Balancer on AWS**

* AWS has **4 kinds of managed Load Balancers:**
    * **Classic Load Balancer(v1-old generation):** 2009 - CLB
        * HTTP, HTTPS, TCP, SSL (Secure TCP)
    * **Application Load Balancer(v2-new generation):** 2016 - ALB
        * HTTP, HTTPS, WebSocket
    * **Network Load Balancer(v2-new generation):** 2017 - NLB
        * TCP, TLS (Secure TCP), UDP
    * **Gateway Load Balancer:** 2020 - GWLB
        * Operates at layer 3 (Network Layer) - IP Protcol

* Overall, it is recommended to use the newer generation load balancer as they provide more features
* Some load balancer can be setup as **internal**(private) or **external**(public) ELBs

**Load Balancer Security Groups**
![Load Balancer Security Groups](./images/load-balancer-security-groups.png)
****

**Sticky Sessions (Session Affinity)**

* It is possible to implement stickiness so that the same client is always redirected to the same instance behind a load balancer
* This works for **Classic Load Balancer, Application Load Balancer and Network Load Balancer**
* The cookie used for stickiness has an expiration date you control
* Use Case: Make sure the user doesn't lose his session data
* Enabling stickiness may bring imbalance to the load over the backend EC2 instances

**Cookie Names**

* **Application Based Cookies**
  * Custom Cookie
    * Generated by the target
    * Can include any custom attributes required by the application
    * Cookie name must be specified individually for each target roup
    * Don't use **AWSALB, AWSALBAPP or AWSALBTG** (Reserved for use by the ELB)
  * Application Cookie
    * Generated by the load balancer
    * Cookie name is **AWSALBAPP**
* **Duration Based Cookies**
  * Cookie generated by the load balancer
  * Cookie name is **AWSALB** for ALB and **AWSELB** for CLB 
****

**Cross-Zone Load Balancing**

* **With Cross Zone Load Balancing:**
  * Each load balancer instance distributes evenly across all registered instances in all AX
* **Without Cross Zone Load Balancing:**
  * Requests are distributed in the instances of the node of the Elastic Load Balancer
* **Application Load Balancer**
  * Enabled by default (can be disabled at the Target Group Level)
  * No charges for inter AZ data
* **Network Load Balancer & Gateway Load Balancer**
  * Disabled by default
  * You pay charges for inter AZ data if enabled
* **Classic Load Balancer**
  * Disabled by default
  * No charges for inter AZ data if enabled
****

**SSL/TLS - Basics**

* An SSL Certificate allows traffic between your clients and your load balancer to be encrypted in transit (in-flight encryption)
* **SSL** refers to Secure Sockets Layer, used to encrypt connections
* **TLS** refers to Transport Layer Security, which is a newer version
* Nowadays, **TLS certificates are mainly used**, but people still refer as SSL
* Public SSL certificates are issued by Certificate Authorities (CA)
* Comodo, Symantec, GoDaddy, GlobalSign, Digicert, Letsecrypt, etc...
* SSL certificates have an expiration date (you set) and must be renewed
  
**Load Balancer - SSL Certificates**

* The load balancer uses an X.509 certificate (SSL/TLS server certificate)
* You can manage certificates using ACM (AWS Certificate Manager)
* You can create, upload your own certificates alternatively
* HTTPS listener:
  * You must specify a default certificate
  * You can add an optional list of certs to support multiple domains
  * **Clients can use SNI (Server Name Indication) to specify the hostname they reach
  * Ability to specify a security policy to support older versions of SSL/TLS (legacy clients)

**Server Name Indication**

* SNI solves the problem of loading **multiple SSL certificates onto one web server** (to serve multiple websites)
* It's a "newer" protocol, and requires the client to **indicate** the hostname of the target server in the initial SSL handshake
* The server will then find the correct certificate, or return the default one
* Only works for ALB & NLB (newer generation), CloudFront
* Does not work for CLB (old gen) 

**Elastic Load Balancers - SSL Certificates**

* **Classic Load Balancer(v1)**
  * Support only one SSL certificate
  * Must use multiple CLB for multiple hostname with multiple SSL certificates
* **Application Load Balancer(v2)**
  * Supports multiple listeners with multiple SSL certificates
  * Uses Server Name Indication (SNI) to make it work
* **Network Load Balancer(V2)**
  * Supports multiple listeners with multiple SSL certificates
****

**Connection Draining**

* **Feature Naming**
  * Connection Draining - for CLB
  * Deregistration Delay - for ALB & NLB
* Time to complete "in-flight requests" while the instance is de-registering or unhealthy
* Stops sending new requests to the EC2 instance which is de-registering
* Between 1 to 3600 seconds (default: 300 seconds)
* Can be disabled (set value to 0)
* Set to a low value if your requests are short
